<!DOCTYPE html>
<html>
<head>
  <base target="_blank">
<?!= include_html_("UI/Common") ?>
</head>
<body>
  <p>Чтобы редакторы ведомости могли загружать файлы в ведомость, необходимо создать реестр загрузок и ввести параметры файлового хранилища.</p>
  <div>
    <h3>Реестр загрузок</h3>
    <p>Это просто вкладка <code>uploads</code> ведомости.</p>
  </div>
  <div>
    <h3>Параметры хранилища</h3>
    <p class="block">Подойдёт любое S3-совместимое хранилище. Подробнее читайте ниже.</p>
    <label class="block form-group">
      Ключ доступа / Access key<br/>
      <input type="text"/>
    </label>
    <label class="block form-group">
      Секретный ключ / Secret key<br/>
      <input type="text"/>
    </label>
    <label class="block form-group">
      Регион / Region<br/>
      <input type="text"/>
    </label>
    <label class="block form-group">
      Адрес хранилища / Bucket URL<br/>
      <input type="text"/>
      <!-- XXX примечания:
      - адрес должен использовать HTTPS
      - после доменного имени должен идти слеш
      - адрес не должен вызывать перенаправлений (например, для Amazon адрес должен включать регион)
      - адрес может содержать префикс названий (внутри хранилища)
      -->
    </label>
  </div>
  <div>
    <h3>Найстройка хранилища</h3>
    <p>Сервис S3-совместимых облачных хранилищ предоставляют многие компании, например,
      <a href="https://aws.amazon.com/s3/">Amazon</a>,
      <a href="https://cloud.google.com/storage/">Google</a> или
      <a href="https://cloud.yandex.com/services/storage">Yandex</a>.</p>
    <p>Чтобы хранилище можно было использовать для загрузки файлов в ведомость, необходимо настроить к нему доступ:
    <ul>
      <li>GET: разрешение на скачивание файлов из хранилища для всех пользователей;</li>
      <li>PUT: право загрузки файлов в хранилище для сервисного аккаунта;</li>
      <li>CORS (PUT): возможность для скрипта обращаться к хранилищу из браузера.</li>
    </ul>
    </p>
    <h3>GET</h3>
    <p>Необходимо явно разрешить доступ на чтение (GET/READ) со стороны любых пользователей.</p>
    <h3>PUT</h3>
    <p>Необходимо создать сервисный аккаунт и выдать ему разрешение на загрузку файлов в хранилище. Для сервисного аккаунта нужно сгенерировать ключ доступа и секретный ключ, которые и следует ввести в поля выше. Эти ключи будут храниться в настройках скрипта и, технически, будут доступны любым редакторам таблицы.</p>
    <h3>CORS (PUT)</h3>
    <p>Так как загрузка файлов производится непосредственно из браузера, хранилище должно корректно принимать CORS-запросы из источника <code>https://*-script.googleusercontent.com</code>.</p>
    <p>Например, в Amazon соответствующая конфигурация хранилища выглядит как-то так:
<code style="display: block; white-space: pre; overflow-x: scroll;"><?= ((
`<CORSConfiguration>
  <CORSRule>
    <AllowedOrigin>https://*-script.googleusercontent.com</AllowedOrigin>
    <AllowedMethod>PUT</AllowedMethod>
    <AllowedHeader>Content-Type</AllowedHeader>
    <AllowedHeader>Content-Length</AllowedHeader>
    <AllowedHeader>Authorization</AllowedHeader>
    <AllowedHeader>X-Amz-Content-Sha256</AllowedHeader>
    <AllowedHeader>X-Amz-Date</AllowedHeader>
    <MaxAgeSeconds>3600</MaxAgeSeconds>
  </CORSRule>
</CORSConfiguration>`).replace(/\n  /g, "\n")) ?></code></p>
    <p>В Google настройки CORS можно внести только через терминал; проще всего открыть <a href="https://shell.cloud.google.com/?show=terminal">Google Cloud Shell</a> и вставить <code style="display: block; white-space: pre; overflow-x: scroll;"><?= ((
`echo -n "Your bucket name: " && read YOURBUCKETNAME && \\
gsutil cors set /proc/self/fd/0 gs://\${YOURBUCKETNAME} <<EOF
[
  {
    "origin": [
      "https://*-script.googleusercontent.com"
    ],
    "responseHeader": [
      "Content-Type", "Content-Length", "Authorization",
      "x-amz-content-sha256", "x-amz-date"
    ],
    "method": ["PUT"],
    "maxAgeSeconds": 3600
  }
]
EOF`).replace(/\n  /g, "\n")) ?></code>
ввести название хранилища и нажать <code>Enter</code>.</p>
  </div>
<script>
</script>
</body>
</html>

